# BUPT DNS Relay

北京邮电大学计算机网络课程设计

**作者：** llh

**License：** MIT

完全采用C语言实现的DNS Relay，但作者本人对此颇有怨念。

环境：macOS / Linux

采用cmake编译，木有写编译选项（因为不会）

## 功能

DNS中转服务。支持对A请求和AAAA请求的解析和处理，多线程处理，使用pthread实现。不能处理的解析提交给外部DNS服务器处理。

* Host功能
* Host黑名单
* 本地缓存
* 本地CNAME递归查询

只要编译并启动就可以执行了。监听53端口可能需要sudo。

## 已知的问题与改进方案

### 问题

* 没有进行大小写转换，可能有潜在的BUG（cache里有一张表做了字符映射一定程度避免了这个问题，但host没做处理）
* 有些处理没有进行安全检查，对于特别构造的恶意查询数据可能发生Segment Fault;
    * ~~但是我很懒所以并不想处理这个问题~~
* 本地缓存是采用Trie树实现的。虽然Trie树效率很高，但其内存占用巨大;
* 可能有内存泄漏；
    * 我真的不怎么用纯C写东西。我对与``new``和``delete``的使用还是很有把握的，当然RAII就更好了，但C语言真的一言不合``void *``满天飞真的令人头大。
* Host文件不支持注释，也没有对读入的内容进行检查，所以很容易炸掉（就是单纯的``fscanf(FILE, "%s%s", str1, str2)``）

### 一些改进方案和想法

说不定哪天我心情好就用C++或者rust重构一下呢。

* 缓存改用平衡树存储。
    * C++写AVL很痛苦，C写AVL那简直不是人干的事，红黑树同理。~~写哈希表是不可能的，这辈子都不可能的。~~ 
    * ~~要不是不准用C++，我就是手写红黑树也不用Trie~~
* 也可以直接上数据库
* 加上配置文件的支持(比如dns_relay.conf)
* 加上Windows环境的支持（搞一搞宏定义应该就差不多了）
* 请求队列改成无锁队列
* 完善协议支持（这个是在想屁吃）

### 如果用C++重构

* model文件夹可以去掉了。里边基本都是存储用的容器。
* 可以对dns.h/dns.c里某些函数进行重载
* ~~像cache什么的当然要上``std::map``啦（去他妈的访问速度）~~

暂时就想到这些

---

## 代码结构

model文件夹中大都是一些存储容器或者数据结构。核心功能都在core文件夹和main.c中。

我写这个程序的时候大致是按照下面的顺序写的：

 0. 搞定日志记录模块
 1. 搞定socket通信
 2. 搞定监听队列
 3. 搞定中转
 4. 搞定存储用的容器
 5. 搞定DNS Query和Answer的解析
 6. 搞定存储记录的格式和Cache存储
 7. 搞定Answer的构造
 8. 搞定递归查询
 9. 搞定Host和黑名单功能

日志记录模块在logger.h/logger.c中，借助``__vfprintf``实现；

socket通信全部在socket.h/socket.c中；

监听队列负责监听请求并放入队列，单独占用一个线程，在request_cache.h/request_cache.c中实现；

中转在main.c中的``handle_in_remote_server()``函数实现，依赖于socket通信和监听队列；

存储用容器和数据结构在model文件夹内实现，除了``struct raw_data``在unidef.h中实现，``struct request_data``在request_cache.h中实现；

所有处理DNS请求和Response相关内容均在dns.h/dns.c中实现，包括解析和构造。dns.h/dns.c仅依赖与存储容器和数据结构，构成整个程序的真正基础；（查询不在dns.h/dns.c中实现，因为其依赖于缓存）

Cache的存储、查询与更新在cache.h/cache.c中实现；

递归查询在inverse_query.h/inverse_query.c中实现；

Host和黑名单的存储与查询在host.h/host.c中实现；

unidef.h中存放一些宏定义，该文件被core文件夹内所有代码文件引入；

test.h/test.c用于测试部分功能运作是否正常，它们现在没用了；

model文件夹下的record.h/record.c是我写代码的中间产物，它们现在应该没用了。

## 代码风格

因为写的时候我断断续续地磨叽了两个月，中间受一些书籍或博客的影响代码风格有所变化，所以前后代码风格有些许不一致。

* 函数和变量采用小写字母+下划线的形式命名；
* static函数前加两道下划线``_``；
* 常量宏定义/枚举采用大写字母+下划线的形式；
* 先前特定名称如A、CNAME和AAAA我保留大写的形式，后来又采用小写的形式，所以这里非常混乱。
